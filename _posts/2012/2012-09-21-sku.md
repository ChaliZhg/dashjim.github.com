---
layout: post
title: SKU算法
categories:
- Programming
tags:
- iOS
- SKU
- Taobao
---
###知识准备

在淘宝中，产品指的是标准化产品,由(类目,关键属性)决定，如一个手机产品由 (手机类目,(品牌,型号))决定。
SPU，Standard Product Unit(标准化产品单元)，一般是由关键属性及关键属性的属性值组合而成的。
SKU，Stock Keeping Uint(库存量单位)，由销售属性，销售属性属性值的组合而成，它直接影响买家的购买和卖家的库存管理，如 某个服装的 (颜色:黑色，尺码:XXL)，也就是说一个SKU的形式就是 p1:v1;p2:v2;... 这样的键值对的组合，我们暂且将其叫做ppath(Property Path),实际应用中p1,v1这些都是使用相应的数字id表示的.
如果想详细了解某个类目下的某类产品的各种属性可以通过属性工具进行查看:
[属性工具](http://open.taobao.com/api_tool/props/)  。
我们通常所说的"宝贝"其实指的是商品, 简单的说一般情况下一个商品是由SPU+SKU决定的。

### 接口数据
为了计算机实现，产品的关键属性以及销售属性以及他们的属性值在计算机系统都会进行编码，使用数字来表示，方便计算机进行计算。
一个SKU结构 一般包含 skuId；SKU的ppath(p1:v1;p2:v2:p3:v3...)，用来表示当前SKU由哪些销售属性组成以及对应的属性值是什么，还有当前SKU使用到的关键属性id以及关键属性值id对应的中文名字符串;当前SKU的库存；当前SKU的价格。

当然不同的接口返回的SKU的数据结构会不太相同，但是包含的信息量是一致的。

以下是网页中商品的SKU选择控件的显示，从中可以看出一些眉目来
* 一个属性 对应多个属性值，用户需要对属性值进行选择
* 当有多个属性存在时，用户需要进行多维度的选择，最终的SKU是组合而成
* 当一个属性的属性值被选择之后可能会对其他的属性的属性值的可选性产生影响，因为某些SKU可能没有库存了。这样一个SKU属性值选择了之后，别的属性的属性值选择按钮就disabled了.

### 控件实现
控件实现的重点就是，某个属性值按钮选择后其他属性的属性值按钮的可选择性状态的更新，以及选择了一个属性值之后，需要检查当前已经选择的"属性属性值对"组合 能否构成一个完整的SKU，如果能则将控件的selectedSku设置为指定的SKU对象，否则设置为nil.

##### 数据准备
在数据准备阶段，
1. 需要建立一个SKU的Map，key为SKU的ppath ，value为SKU对象
2. 需要一个SKU的键值对可能存在的组合的一个Map，主要是为了检测一个属性值按钮选择之后对其他属性的属性值可选性的影响，key为键值对组合，value就为1,没有实际意义
3. 如果在所有有存货的SKU中都没有某个属性值出现，那么需要将其剔除，要不然那个属性值按钮一直处于disabled状态

主要涉及的算法就是第2步中的SKU的键值对可能存在的组合，其本质就就是依次对每一个SKU的ppath求其属性键值对组合的非空子集，然后去除重复的以及没有存货的便可。计算某个SKUppath求其属性键值对组合的非空子集的算法可以使用二进制位的方式进行计算。
对一个SKU的ppath而言，在其某一个子集中，每一个属性键值对其状态无非有两个，不存在和存在，我们分别用0和1表示，那么有n个键值对的SKU所有的子集个数位2^n 去除一个空集后位2^n - 1.

#### 创建和状态更新
当数据都准备好了，就开始针对每一个属性创建出其所有的属性值的按钮控件，按钮显示的属性值对应的中文。
所有的属性值按钮都创建OK了之后，当我们点击某个属性值按钮之后，需要根据之前创建的"SKU的键值对可能存在的组合子集"对所有的非当前属性的属性值的可选性进行更新。